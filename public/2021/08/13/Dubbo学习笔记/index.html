<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Dubbo学习笔记 | Amzpiper</title><meta name="keywords" content="Dubbo"><meta name="author" content="Amzpiper"><meta name="copyright" content="Amzpiper"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、基本知识1 分布式基础理论1.1什么是分布式分布式系统是若干个独立计算机的集合，，计算机对于用户来说就像个单个系统，建立在网络上的软件系统。 随着互联网的发展，规模不断扩大，垂直应用架构无法应付，需要一个治理系统确保架构有条不紊的演进。 dubbo作用：治理和维护各个分系统。 1.2 发展演变： 单一应用架构： 流量小时，所有功能放到一起，减少部署节点和成本。  缺点： 扩展不容易，需要重新打">
<meta property="og:type" content="article">
<meta property="og:title" content="Dubbo学习笔记">
<meta property="og:url" content="https://github.com/amzpiper/2021/08/13/Dubbo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Amzpiper">
<meta property="og:description" content="一、基本知识1 分布式基础理论1.1什么是分布式分布式系统是若干个独立计算机的集合，，计算机对于用户来说就像个单个系统，建立在网络上的软件系统。 随着互联网的发展，规模不断扩大，垂直应用架构无法应付，需要一个治理系统确保架构有条不紊的演进。 dubbo作用：治理和维护各个分系统。 1.2 发展演变： 单一应用架构： 流量小时，所有功能放到一起，减少部署节点和成本。  缺点： 扩展不容易，需要重新打">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/amzpiper/2021/08/13/Dubbo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/logo.jpeg">
<meta property="article:published_time" content="2021-08-13T02:00:41.000Z">
<meta property="article:modified_time" content="2021-12-06T02:10:35.331Z">
<meta property="article:author" content="Amzpiper">
<meta property="article:tag" content="Dubbo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/amzpiper/2021/08/13/Dubbo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/logo.jpeg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://github.com/amzpiper/2021/08/13/Dubbo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Dubbo学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-12-06 10:10:35'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/my/index.min.css"><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpeg" onerror="onerror=null;src='/img/loading.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 总览</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2021/08/13/Dubbo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/logo.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Amzpiper</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 总览</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Dubbo学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-08-13T02:00:41.000Z" title="发表于 2021-08-13 10:00:41">2021-08-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-12-06T02:10:35.331Z" title="更新于 2021-12-06 10:10:35">2021-12-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Dubbo学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、基本知识"><a href="#一、基本知识" class="headerlink" title="一、基本知识"></a>一、基本知识</h1><h2 id="1-分布式基础理论"><a href="#1-分布式基础理论" class="headerlink" title="1 分布式基础理论"></a>1 分布式基础理论</h2><h3 id="1-1什么是分布式"><a href="#1-1什么是分布式" class="headerlink" title="1.1什么是分布式"></a>1.1什么是分布式</h3><p>分布式系统是若干个独立计算机的集合，，计算机对于用户来说就像个单个系统，建立在网络上的软件系统。</p>
<p>随着互联网的发展，规模不断扩大，垂直应用架构无法应付，需要一个治理系统确保架构有条不紊的演进。</p>
<p>dubbo作用：治理和维护各个分系统。</p>
<h3 id="1-2-发展演变："><a href="#1-2-发展演变：" class="headerlink" title="1.2 发展演变："></a>1.2 发展演变：</h3><p><img src="Untitled.png" alt="Untitled.png"></p>
<p><strong>单一应用架构：</strong></p>
<p>流量小时，所有功能放到一起，减少部署节点和成本。</p>
<p><img src="Untitled%201.png" alt="Untitled%201.png"></p>
<p>缺点：</p>
<p>扩展不容易，需要重新打包重新部署</p>
<p>协同开发不容易</p>
<p>扩大性能提升不容易</p>
<p><strong>垂直应用架构：</strong></p>
<p>小功能独立为单个应用，部署在多个服务器上</p>
<p><img src="Untitled%202.png" alt="Untitled%202.png"></p>
<p>优点：</p>
<p>分工合作容易，分别负责开发</p>
<p>性能扩展容易，多部署到几个服务器</p>
<p>缺点：</p>
<p>单个应用从头到尾都有的，包括页面逻辑和数据库。但是市场上界面改变快，改了需要重新部署，没法做到页面和业务逻辑的分离</p>
<p>垂直应用越来越多，不可能完全应用于应用完全独立。用户调用订单和商品，物流调用订单等。应用之间需要交互</p>
<p><strong>分布式服务架构：</strong></p>
<p>核心业务单独抽取出来，用户应用抽取为页面和业务逻辑。当业务逻辑不变时只改界面，界面重新部署就行了。</p>
<p><img src="Untitled%203.png" alt="Untitled%203.png"></p>
<p>问题：</p>
<p>用户web可能再A服务器上，业务再B服务器。如果A服务器调用B服务器功能时，因为不在一个进程内，分隔异地了，这2个代码调用需要RPC远程过程调用。</p>
<p>难点：</p>
<p>如何远程过程调用</p>
<p>如何拆分业务，增加业务的复用程度</p>
<p>好的分布式服务框架（RPC），应该有调度中心，来实时的监控业务中心实现动态调度，增加利用率，当某一个业务调用多了，可以让更多的服务器来跑业务量更大的业务，这是用流动计算架构</p>
<p><strong>流动计算架构：</strong></p>
<p><img src="Untitled%204.png" alt="Untitled%204.png"></p>
<p>它负责维护业务之间复杂的关系，以及实时管理服务集群，当A访问量大了，可以多来几台服务器。而且多个A服务器中按照访问量动态调用，以此来提高集群的利用率。</p>
<h3 id="1-3-RPC"><a href="#1-3-RPC" class="headerlink" title="1.3 RPC"></a>1.3 RPC</h3><p><strong>什么叫RPC</strong></p>
<p>远程过程调用，A服务器调用B服务器上功能。是一种技术思想，不是规范。它允许程序调用另一个共享空间（通常是共享网络的另一台服务器）上的过程或函数。而不是程序员显示编码这个远程调用的细节。即程序员无论调用本地的还是远程的函数，本质上编写的调用代码基本相同。</p>
<p><strong>RPC基本原理</strong></p>
<p><img src="Untitled%205.png" alt="Untitled%205.png"></p>
<p>clent functions想调用server functions时，通过小助手请求，通过sockets创建和server的sockets连接，将想调用的信息传递个server服务器，server小助手收到信息后确定调用函数，server用传递过来的信息调用自己方法后把返回值再通过网络sockets返回给client</p>
<p>A和B架起网络连接后调用</p>
<p><strong>例子：</strong></p>
<p><img src="Untitled%206.png" alt="Untitled%206.png"></p>
<p>A调用B时传递对象需要序列化，B先反序列化为对象，B服务器调用一下，拿到返回值，通过网络传输，序列化后传输给A服务器，A服务器需要反序列化后拿到返回值。</p>
<p><strong>调用核心：</strong></p>
<p>AB两个需要建立连接</p>
<p>传递数据需要序列化和反序列化</p>
<p><strong>决定性能有两点：</strong></p>
<p>看RPC能否快速建立连接</p>
<p>序列化于反序列化是否快</p>
<p><strong>RPC框架：</strong></p>
<p>dubbo、gRPC、Thrift、HSF</p>
<p>思想相同，用法不同</p>
<h2 id="2-dubbo核心概念"><a href="#2-dubbo核心概念" class="headerlink" title="2 dubbo核心概念"></a>2 dubbo核心概念</h2><h3 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>Apache Dubbo 是一款高性能、轻量级的开源 Java 服务框架</p>
<p>注：rpc面向服务、cloud的是restful面向资源</p>
<p>14.10停止更新，18.1将dubbo和dubbox合并后发布为2.6版本，最终将dubbo开放到apache。</p>
<p>netty功能负责网络传输，dubbo使用netty作为网络传输框架。说到网络传输自然离不开Socket，Socket是端到端的连接。dubbo是无中心化，每个client端都能与server端连接，每个client端同时又是server端。</p>
<p><strong>特性：</strong></p>
<p>1.<strong>面向接口代理的高性能RPC调用</strong></p>
<p>提供高性能的基于代理的远程调用能力，服务以接口为粒度，为开发者屏蔽远程调用底层细节。</p>
<p>A调用B只需要将接口拿来调用，dubbo会自动的找B服务器的这段代码，屏蔽了整个调用细节。</p>
<p>类似Mybatis，调用数据库是只需要写do-mapping接口，调用接口方法就行了。</p>
<p><strong>2.智能负载均衡</strong></p>
<p>内置多种负载均衡策略，智能感知下游节点健康状况，显著减少调用延迟，提高系统吞吐量。</p>
<p>一个服务1台服务器不够时部署多台后，会自动找空闲服务器运行。</p>
<p>不会压垮某一台服务器，也不会让某服务器太闲浪费资源。</p>
<p><strong>3.服务自动注册与发现</strong></p>
<p>支持多种注册中心服务，服务实例上下线实时感知。</p>
<p>业务非常多，订单调用支付业务时如何知道业务服务器是否知道有问题切在哪，为了动态感知，将所有程序注册到注册中心，维护注册清单。调用时会问一下调用的服务在哪个服务器，选择请求量最小的。建立通信，进行远程调用。</p>
<p><strong>4.高度可扩展能力</strong></p>
<p>遵循微内核+插件的设计原则，所有核心能力如Protocol、Transport、Serialization被设计为扩展点，平等对待内置实现和第三方实现。</p>
<p>所有东西都可扩展。</p>
<p><strong>5.运行期流量调度</strong></p>
<p>内置条件、脚本等路由策略，通过配置不同的路由规则，轻松实现灰度发布，同机房优先等功能。</p>
<p>灰度发布：比如有个用户服务，现在在100台上服务器在跑，用户服务做了升级，害怕升级不稳定，可以先选定20台服务器，让他们用新版本的用户服务，剩下80台用旧版本的用户服务。等20台用的没问题了，再选20台，一点一点增加，知道100台都过度到新版本用户服务。可以配置不同路由规则，请求进来后一部分用新版本服务。慢慢从旧服务转变到新服务的过程。</p>
<p><strong>6.可视化的服务治理与运维</strong></p>
<p>提供丰富服务治理、运维工具：随时查询服务元数据、服务健康状态及调用统计，实时下发路由策略、调整配置参数。</p>
<p>可以随时查询服务的信息、健康状况、调用统计记录等等。通过可视化界面。</p>
<h3 id="2-2-dubbo设计架构"><a href="#2-2-dubbo设计架构" class="headerlink" title="2.2 dubbo设计架构"></a>2.2 dubbo设计架构</h3><p><img src="Untitled%207.png" alt="Untitled%207.png"></p>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/6c6f03ae75794978a31ec967f82fec02">节点角色说明</a></p>
<p><strong>运行流程</strong></p>
<ol>
<li>服务容器负责启动，加载，运行服务提供者。</li>
<li>服务提供者在启动时，向注册中心注册自己提供的服务。</li>
<li>服务消费者在启动时，向注册中心订阅自己所需的服务。当某一个提供者下线了，基于长连接方式，将这个变更推送给消费者，可以实时知道有一个提供者不能调用了。当消费者拿到所有可以调的服务后，可以调用提供者提供的服务，调用时根据负载均衡算法选择一个提供者调用。</li>
<li>注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。</li>
<li>服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。</li>
<li>服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。</li>
</ol>
<p>Dubbo 架构具有以下几个特点，分别是连通性、健壮性、伸缩性、以及向未来架构的升级性。</p>
<p>0、1、2是初始时启动完成的，第3、5布是异步的。第4步是同步调用。</p>
<p>应先创建提供者，注册到注册中心，再编写消费者，消费者从注册中心调用提供者。然后再编写消费者如何消费提供者提供的功能。</p>
<p><strong>连通性<a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/preface/architecture/#%E8%BF%9E%E9%80%9A%E6%80%A7"></a></strong></p>
<ul>
<li>注册中心负责服务地址的注册与查找，相当于目录服务，服务提供者和消费者只在启动时与注册中心交互，注册中心不转发请求，压力较小</li>
<li>监控中心负责统计各服务调用次数，调用时间等，统计先在内存汇总后每分钟一次发送到监控中心服务器，并以报表展示</li>
<li>服务提供者向注册中心注册其提供的服务，并汇报调用时间到监控中心，此时间不包含网络开销</li>
<li>服务消费者向注册中心获取服务提供者地址列表，并根据负载算法直接调用提供者，同时汇报调用时间到监控中心，此时间包含网络开销</li>
<li>注册中心，服务提供者，服务消费者三者之间均为长连接，监控中心除外</li>
<li>注册中心通过长连接感知服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者</li>
<li>注册中心和监控中心全部宕机，不影响已运行的提供者和消费者，消费者在本地缓存了提供者列表</li>
<li>注册中心和监控中心都是可选的，服务消费者可以直连服务提供者</li>
</ul>
<p><strong>健壮性</strong></p>
<ul>
<li>监控中心宕掉不影响使用，只是丢失部分采样数据</li>
<li>数据库宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务</li>
<li>注册中心对等集群，任意一台宕掉后，将自动切换到另一台</li>
<li>注册中心全部宕掉后，服务提供者和服务消费者仍能通过本地缓存通讯</li>
<li>服务提供者无状态，任意一台宕掉后，不影响使用</li>
<li>服务提供者全部宕掉后，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复</li>
</ul>
<p><strong>伸缩性</strong></p>
<ul>
<li>注册中心为对等集群，可动态增加机器部署实例，所有客户端将自动发现新的注册中心</li>
<li>服务提供者无状态，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给消费者</li>
</ul>
<p><strong>升级性<a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/preface/architecture/#%E5%8D%87%E7%BA%A7%E6%80%A7"></a></strong></p>
<p>当服务集群规模进一步扩大，带动IT治理结构进一步升级，需要实现动态部署，进行流动计算，现有分布式服务架构不会带来阻力。</p>
<h2 id="3-dubbo环境搭建"><a href="#3-dubbo环境搭建" class="headerlink" title="3 dubbo环境搭建"></a>3 dubbo环境搭建</h2><h3 id="3-1-搭建Zookeeper注册中心"><a href="#3-1-搭建Zookeeper注册中心" class="headerlink" title="3.1 搭建Zookeeper注册中心"></a>3.1 搭建Zookeeper注册中心</h3><p><strong>3.1.1 安装jdk</strong></p>
<p>上传jdk包到/opt/software</p>
<p>tar -zxvf jdk-8u291-linux-x64.tar.gz</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> JAVA_HOME=<span class="regexp">/opt/</span>software/jdk1<span class="number">.8</span><span class="number">.0_291</span>/  #jdk安装目录</span><br><span class="line"><span class="keyword">export</span> JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br><span class="line"><span class="keyword">export</span> CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib:$&#123;JRE_HOME&#125;/lib:$CLASSPATH</span><br><span class="line"><span class="keyword">export</span> JAVA_PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;JRE_HOME&#125;/bin</span><br><span class="line"><span class="keyword">export</span> PATH=$PATH:$&#123;JAVA_PATH&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3.1.2安装zookeeper</strong></p>
<p>拷贝到/opt/software</p>
<p>解压</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf apache-zookeeper-<span class="number">3.7</span><span class="number">.0</span>.tar.gz</span><br></pre></td></tr></table></figure>
<p><strong>3.1.3修改zookeeper配置</strong></p>
<p>将”/opt/software/apache-zookeeper-3.7.0/conf/zoo_sample.cfg”拷贝份zoo.cfg</p>
<p>打开zoo.cfg，修改vim zoo.cfg</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataDir=<span class="regexp">/opt/</span>software/apache-zookeeper-<span class="number">3.7</span><span class="number">.0</span>/zkData/</span><br></pre></td></tr></table></figure>
<p><strong>3.1.4操作zookeeper</strong></p>
<p>(1) 启动zookeeper</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/software/apache-zookeeper-<span class="number">3.7</span><span class="number">.0</span>/bin</span><br><span class="line">./zkServer.sh start</span><br></pre></td></tr></table></figure>
<p>(2) 查看进程</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jps</span><br><span class="line">./zkServer.sh status</span><br></pre></td></tr></table></figure>
<p>(3)启动客户端</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./zkCli.sh</span><br><span class="line">quit</span><br></pre></td></tr></table></figure>
<p>(4) 关闭zookeeper</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./zkServer.sh stop</span><br></pre></td></tr></table></figure>
<h3 id="3-2-搭建监控中心"><a href="#3-2-搭建监控中心" class="headerlink" title="3.2. 搭建监控中心"></a>3.2. 搭建监控中心</h3><p><a href="https://github.com/apache/dubbo-admin">https://github.com/apache/dubbo-admin</a></p>
<p>root</p>
<p>root</p>
<p>3.2.1 <strong>服务治理</strong></p>
<p>服务治理的部分，按照Dubbo 2.7的格式进行配置，同时兼容Dubbo 2.6，详见<a href="https://github.com/apache/dubbo-admin/wiki/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%85%BC%E5%AE%B9%E6%80%A7%E8%AF%B4%E6%98%8E">这里</a></p>
<p>3.2.2 <strong>前端部分</strong></p>
<ul>
<li>使用<a target="_blank" rel="noopener" href="https://vuejs.org/">Vue.js</a>作为javascript框架</li>
<li><a href="https://github.com/apache/dubbo-admin/blob/develop/dubbo-admin-ui/README.md">dubbo-admin-ui/README.md</a>中有更详细的介绍</li>
<li>设置 npm <strong>代理镜像</strong> : 如果遇到了网络问题，可以设置npm代理镜像来加速npm install的过程：在~/.npmrc中增加 <code>registry =https://registry.npm.taobao.org</code></li>
</ul>
<p>3.2.3 <strong>后端部分</strong></p>
<ul>
<li>标准spring boot工程</li>
<li><a href="https://github.com/apache/dubbo-admin/wiki/Dubbo-Admin%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E">application.properties配置说明</a></li>
</ul>
<p>3.2.4 <strong>生产环境配置</strong></p>
<ol>
<li><p>下载代码: <code>git clone https://github.com/apache/dubbo-admin.git</code></p>
</li>
<li><p>在 <code>dubbo-admin-server/src/main/resources/application.properties</code>中指定注册中心地址</p>
</li>
<li><p>构建</p>
<blockquote>
<p>mvn clean package -Dmaven.test.skip=true</p>
</blockquote>
</li>
<li><p>启动</p>
<ul>
<li><code>mvn --projects dubbo-admin-server spring-boot:run</code>或者</li>
<li><code>cd dubbo-admin-distribution/target; java -jar dubbo-admin-0.1.jar</code></li>
</ul>
</li>
<li><p>访问 <code>http://localhost:8080</code></p>
</li>
</ol>
<hr>
<p>3.2.5 <strong>开发环境配置</strong></p>
<ul>
<li>运行<code>dubbo admin server, dubbo admin server</code>是一个标准的spring boot项目, 可以在任何java IDE中运行它</li>
<li>运行<code>dubbo admin ui</code> <code>dubbo admin ui</code>由npm管理和构建，在开发环境中，可以单独运行: <code>npm run dev</code></li>
<li>页面访问 访问 <code>http://localhost:8081</code>, 由于前后端分开部署，前端支持热加载，任何页面的修改都可以实时反馈，不需要重启应用。</li>
</ul>
<p>3.2.6 <strong>Swagger 支持</strong></p>
<p>部署完成后，可以访问 <a target="_blank" rel="noopener" href="http://localhost:8080/swagger-ui.html">http://localhost:8080/swagger-ui.html</a> 来查看所有的restful api</p>
<h3 id="4-dubbo-helloworld"><a href="#4-dubbo-helloworld" class="headerlink" title="4 dubbo-helloworld"></a>4 dubbo-helloworld</h3><p><strong>4.1 需求</strong></p>
<p><img src="Untitled%208.png" alt="Untitled%208.png"></p>
<p><strong>4.2 工程架构</strong> </p>
<p><img src="Untitled%209.png" alt="Untitled%209.png"></p>
<p>服务化最佳实践</p>
<p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/best-practice/">https://dubbo.apache.org/zh/docs/v2.7/user/best-practice/</a></p>
<p>分包：</p>
<p>建议将服务接口、服务模型、服务异常等均放在 API 包中，因为服务模型和异常也是 API 的一部分，这样做也符合分包原则：重用发布等价原则(REP)，共同重用原则(CRP)。</p>
<p>如果需要，也可以考虑在 API 包中放置一份 Spring 的引用配置，这样使用方只需在 Spring 加载过程中引用此配置即可。配置建议放在模块的包目录下，以免冲突，如：<code>com/alibaba/china/xxx/dubbo-reference.xml</code>。</p>
<p>粒度：</p>
<p>服务接口尽可能大粒度，每个服务方法应代表一个功能，而不是某功能的一个步骤，否则将面临分布式事务问题，Dubbo 暂未提供分布式事务支持。</p>
<p>服务接口建议以业务场景为单位划分，并对相近业务做抽象，防止接口数量爆炸。</p>
<p>不建议使用过于抽象的通用接口，如：<code>Map query(Map)</code>，这样的接口没有明确语义，会给后期维护带来不便。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="number">1</span>、指定当前服务/应用的名字（同样的服务名字相同，不要和别的服务同名） --&gt;</span><br><span class="line">&lt;dubbo:application name=<span class="string">&quot;user-service-provider&quot;</span>&gt;&lt;/dubbo:application&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- <span class="number">2</span>、指定注册中心的位置 --&gt;</span><br><span class="line">&lt;!-- <span class="xml"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;zookeeper://127.0.0.1:2181&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">dubbo:registry</span>&gt;</span></span> --&gt;</span><br><span class="line">&lt;dubbo:registry protocol=<span class="string">&quot;zookeeper&quot;</span> address=<span class="string">&quot;127.0.0.1:2181&quot;</span>&gt;&lt;/dubbo:registry&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- <span class="number">3</span>、指定通信规则（通信协议？通信端口） --&gt;</span><br><span class="line">&lt;dubbo:protocol name=<span class="string">&quot;dubbo&quot;</span> port=<span class="string">&quot;20882&quot;</span>&gt;&lt;/dubbo:protocol&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- <span class="number">4</span>、暴露服务   ref：指向服务的真正的实现对象 --&gt;</span><br><span class="line">&lt;dubbo:service interface=<span class="string">&quot;gmall.service.OrderService&quot;</span></span><br><span class="line">	ref=<span class="string">&quot;userServiceImpl01&quot;</span> timeout=<span class="string">&quot;1000&quot;</span> version=<span class="string">&quot;1.0.0&quot;</span>&gt;</span><br><span class="line">	&lt;dubbo:method name=<span class="string">&quot;getUserAddressList&quot;</span> timeout=<span class="string">&quot;1000&quot;</span>&gt;&lt;/dubbo:method&gt;</span><br><span class="line">&lt;/dubbo:service&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--统一设置服务提供方的规则  --&gt;</span><br><span class="line">&lt;dubbo:provider timeout=<span class="string">&quot;1000&quot;</span>&gt;&lt;/dubbo:provider&gt;</span><br></pre></td></tr></table></figure>
<p><strong>4.3 创建模块</strong></p>
<p>1、gmall-interface：公共接口层（model，service，exception…）</p>
<p>作用：定义公共接口，也可以导入公共依赖</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、Bean模型</span><br><span class="line">package gmall.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户地址</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">lfy</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserAddress</span> <span class="title">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    private Integer id;</span><br><span class="line">    private <span class="built_in">String</span> userAddress; <span class="comment">//用户地址</span></span><br><span class="line">    private <span class="built_in">String</span> userId; <span class="comment">//用户id</span></span><br><span class="line">    private <span class="built_in">String</span> consignee; <span class="comment">//收货人</span></span><br><span class="line">    private <span class="built_in">String</span> phoneNum; <span class="comment">//电话号码</span></span><br><span class="line">    private <span class="built_in">String</span> isDefault; <span class="comment">//是否为默认地址    Y-是     N-否</span></span><br><span class="line"></span><br><span class="line">    public <span class="function"><span class="title">UserAddress</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public UserAddress(Integer id, <span class="built_in">String</span> userAddress, <span class="built_in">String</span> userId, <span class="built_in">String</span> consignee, <span class="built_in">String</span> phoneNum,</span><br><span class="line">                       <span class="built_in">String</span> isDefault) &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.userAddress = userAddress;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">        <span class="built_in">this</span>.consignee = consignee;</span><br><span class="line">        <span class="built_in">this</span>.phoneNum = phoneNum;</span><br><span class="line">        <span class="built_in">this</span>.isDefault = isDefault;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer <span class="function"><span class="title">getId</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">void</span> <span class="function"><span class="title">setId</span>(<span class="params">Integer id</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">getUserAddress</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">void</span> <span class="function"><span class="title">setUserAddress</span>(<span class="params"><span class="built_in">String</span> userAddress</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userAddress = userAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">getUserId</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">void</span> <span class="function"><span class="title">setUserId</span>(<span class="params"><span class="built_in">String</span> userId</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">getConsignee</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> consignee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">void</span> <span class="function"><span class="title">setConsignee</span>(<span class="params"><span class="built_in">String</span> consignee</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.consignee = consignee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">getPhoneNum</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> phoneNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">void</span> <span class="function"><span class="title">setPhoneNum</span>(<span class="params"><span class="built_in">String</span> phoneNum</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.phoneNum = phoneNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">getIsDefault</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> isDefault;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">void</span> <span class="function"><span class="title">setIsDefault</span>(<span class="params"><span class="built_in">String</span> isDefault</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.isDefault = isDefault;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、OrderService 接口</span><br><span class="line">package gmall.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gmall.bean.UserAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单服务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">guoyh</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2021/7/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public interface OrderService &#123;</span><br><span class="line"></span><br><span class="line">    public List&lt;UserAddress&gt; initOrder(<span class="built_in">String</span> userId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、UserService接口</span><br><span class="line">package gmall.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gmall.bean.UserAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户服务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">guoyh</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2021/7/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public interface UserService &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照用户id返回所有收货地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="variable">userId</span></span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return </span>List&lt;UserAddress&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public List&lt;UserAddress&gt; getUserAddressList(<span class="built_in">String</span> userId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、user-service-provider：用户模块（对用户接口的实现）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、pom.xml</span><br><span class="line">	&lt;!-- 引入公共接口 --&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">	  &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">	  &lt;artifactId&gt;gmall-interface&lt;/artifactId&gt;</span><br><span class="line">	  &lt;version&gt;<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;/dependency&gt;	</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、UserServiceImpl服务</span><br><span class="line">package com.atguigu.gmall.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gmall.bean.UserAddress;</span><br><span class="line"><span class="keyword">import</span> gmall.service.UserService;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、将服务提供者将服务注册到注册中心（暴漏服务）</span></span><br><span class="line"><span class="comment"> * 1) 导入dubbo依赖</span></span><br><span class="line"><span class="comment"> * 2、让服务消费者去注册中心订阅服务的服务地址</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">guoyh</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2021/7/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="title">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;UserAddress&gt; <span class="function"><span class="title">getUserAddressList</span>(<span class="params"><span class="built_in">String</span> userId</span>)</span> &#123;</span><br><span class="line">        UserAddress userAddressOne = <span class="keyword">new</span> UserAddress();</span><br><span class="line">        userAddressOne.setUserAddress(<span class="string">&quot;北京市区昌平&quot;</span>);</span><br><span class="line">        UserAddress userAddressTwo = <span class="keyword">new</span> UserAddress();</span><br><span class="line">        userAddressTwo.setUserAddress(<span class="string">&quot;天安门&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(userAddressOne, userAddressTwo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、user-service-consumer：订单模块（调用用户模块）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、pom.xml</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">	  &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">	  &lt;artifactId&gt;gmall-interface&lt;/artifactId&gt;</span><br><span class="line">	  &lt;version&gt;<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;/dependency&gt;</span><br><span class="line">	</span><br><span class="line"><span class="number">2</span>、OrderServiceImpl服务</span><br><span class="line">package com.atguigu.gmall.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gmall.bean.UserAddress;</span><br><span class="line"><span class="keyword">import</span> gmall.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> gmall.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">guoyh</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2021/7/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Service</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="title">implements</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;UserAddress&gt; <span class="function"><span class="title">initOrder</span>(<span class="params"><span class="built_in">String</span> userId</span>)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;用户id:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">// 1、查询用户收获地址</span></span><br><span class="line">        List&lt;UserAddress&gt; userAddressList = userService.getUserAddressList(userId);</span><br><span class="line">        <span class="keyword">for</span> (UserAddress address : userAddressList) &#123;</span><br><span class="line">            System.out.println(address.getUserAddress());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userAddressList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在这样是无法进行调用的。我们gmall-order-web引入了gmall-interface，但是interface的实现是gmall-user，我们并没有引入，而且实际他可能还在别的服务器中。</p>
<p><strong>4.4 使用dubbo改造</strong></p>
<p>1、改造user-service-provider作为服务提供者</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、pom.xml</span><br><span class="line">	&lt;!-- 引入dubbo --&gt;</span><br><span class="line">	&lt;!-- https:<span class="comment">//mvnrepository.com/artifact/com.alibaba/dubbo --&gt;</span></span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">	  &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">	  &lt;artifactId&gt;dubbo&lt;/artifactId&gt;</span><br><span class="line">	  &lt;version&gt;<span class="number">2.6</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">	&lt;/dependency&gt;</span><br><span class="line">	&lt;!-- 注册中心使用的是zookeeper，引入操作zookeeper的客户端端 --&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">	  &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;</span><br><span class="line">	  &lt;artifactId&gt;curator-framework&lt;/artifactId&gt;</span><br><span class="line">	  &lt;version&gt;<span class="number">2.12</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">	&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、配置提供者provider.xml</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:dubbo=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">		http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd</span></span><br><span class="line"><span class="string">		http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="number">1</span>、指定当前服务/应用的名字（同样的服务名字相同，不要和别的服务同名） --&gt;</span><br><span class="line">    &lt;dubbo:application name=<span class="string">&quot;user-service-provider&quot;</span>&gt;&lt;/dubbo:application&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="number">2</span>、指定注册中心的位置 --&gt;</span><br><span class="line">    &lt;!-- <span class="xml"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;zookeeper://127.0.0.1:2181&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">dubbo:registry</span>&gt;</span></span> --&gt;</span><br><span class="line">    &lt;dubbo:registry protocol=<span class="string">&quot;zookeeper&quot;</span> address=<span class="string">&quot;127.0.0.1:2181&quot;</span>&gt;&lt;/dubbo:registry&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="number">3</span>、指定通信规则（通信协议？通信端口） --&gt;</span><br><span class="line">    &lt;dubbo:protocol name=<span class="string">&quot;dubbo&quot;</span> port=<span class="string">&quot;20882&quot;</span>&gt;&lt;/dubbo:protocol&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="number">4</span>、暴露服务   ref：指向服务的真正的实现对象 --&gt;</span><br><span class="line">    &lt;dubbo:service interface=<span class="string">&quot;gmall.service.UserService&quot;</span></span><br><span class="line">                   ref=<span class="string">&quot;userServiceImpl&quot;</span> timeout=<span class="string">&quot;1000&quot;</span> version=<span class="string">&quot;1.0.0&quot;</span>&gt;</span><br><span class="line">        &lt;!--<span class="xml"><span class="tag">&lt;<span class="name">dubbo:method</span> <span class="attr">name</span>=<span class="string">&quot;getUserAddressList&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;1000&quot;</span>/&gt;</span></span>--&gt;</span><br><span class="line">    &lt;/dubbo:service&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 服务的真正实现 --&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;userServiceImpl&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;com.atguigu.gmall.service.impl.UserServiceImpl&quot;</span>&gt;&lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>启动服务</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</span><br><span class="line">        ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="keyword">new</span> <span class="built_in">String</span>[]&#123;<span class="string">&quot;provider.xml&quot;</span>&#125;);</span><br><span class="line">        context.start();</span><br><span class="line">        <span class="comment">//为了不让服务终止，在这阻塞读取一个字符</span></span><br><span class="line">        System.in.read(); <span class="comment">// 按任意键退出</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、改造user-service-consumer作为服务消费者</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、pom.xml</span><br><span class="line">	&lt;!-- 引入dubbo --&gt;</span><br><span class="line">	&lt;!-- https:<span class="comment">//mvnrepository.com/artifact/com.alibaba/dubbo --&gt;</span></span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">	  &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">	  &lt;artifactId&gt;dubbo&lt;/artifactId&gt;</span><br><span class="line">	  &lt;version&gt;<span class="number">2.6</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">	&lt;/dependency&gt;</span><br><span class="line">	&lt;!-- 注册中心使用的是zookeeper，引入操作zookeeper的客户端端 --&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">	  &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;</span><br><span class="line">	  &lt;artifactId&gt;curator-framework&lt;/artifactId&gt;</span><br><span class="line">	  &lt;version&gt;<span class="number">2.12</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">	&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、配置消费者consumer.xml</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:dubbo=<span class="string">&quot;http://dubbo.apache.org/schema/dubbo&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd</span></span><br><span class="line"><span class="string">		http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd</span></span><br><span class="line"><span class="string">		http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 让注解能够生效 --&gt;</span><br><span class="line">    &lt;context:component-scan base-package=<span class="string">&quot;com.atguigu.gmall.service.impl&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="number">1</span>、指定当前服务/应用的名字（同样的服务名字相同，不要和别的服务同名） --&gt;</span><br><span class="line">    &lt;dubbo:application name=<span class="string">&quot;order-service-consumer&quot;</span>&gt;&lt;/dubbo:application&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="number">2</span>、指定注册中心的位置 --&gt;</span><br><span class="line">    &lt;dubbo:registry address=<span class="string">&quot;zookeeper://127.0.0.1:2181&quot;</span>&gt;&lt;/dubbo:registry&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;!-- <span class="number">3</span>、生成远程服务代理，可以和本地bean一样使用demoService --&gt;</span><br><span class="line">    &lt;dubbo:reference interface=<span class="string">&quot;gmall.service.UserService&quot;</span></span><br><span class="line">                     id=<span class="string">&quot;userService&quot;</span>&gt;</span><br><span class="line">        &lt;dubbo:method name=<span class="string">&quot;getUserAddressList&quot;</span>/&gt;</span><br><span class="line">    &lt;/dubbo:reference&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="number">6</span>、连接监控中心 --&gt;</span><br><span class="line">    &lt;dubbo:monitor protocol=<span class="string">&quot;registry&quot;</span>&gt;&lt;/dubbo:monitor&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>3、调用测试</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package com.atguigu.gmall.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gmall.bean.UserAddress;</span><br><span class="line"><span class="keyword">import</span> gmall.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> gmall.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">guoyh</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2021/7/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Service</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="title">implements</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;UserAddress&gt; <span class="function"><span class="title">initOrder</span>(<span class="params"><span class="built_in">String</span> userId</span>)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;用户id:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">// 1、查询用户收获地址</span></span><br><span class="line">        List&lt;UserAddress&gt; userAddressList = userService.getUserAddressList(userId);</span><br><span class="line">        <span class="keyword">for</span> (UserAddress address : userAddressList) &#123;</span><br><span class="line">            System.out.println(address.getUserAddress());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userAddressList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、注解版本</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、服务提供方</span><br><span class="line">&lt;dubbo:application name=<span class="string">&quot;gmall-user&quot;</span>&gt;&lt;/dubbo:application&gt;</span><br><span class="line">  &lt;dubbo:registry address=<span class="string">&quot;zookeeper://118.24.44.169:2181&quot;</span> /&gt;</span><br><span class="line">  &lt;dubbo:protocol name=<span class="string">&quot;dubbo&quot;</span> port=<span class="string">&quot;20880&quot;</span> /&gt;</span><br><span class="line">&lt;dubbo:annotation package=<span class="string">&quot;com.atguigu.gmall.user.impl&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.gmall.bean.UserAddress;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.gmall.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.gmall.user.mapper.UserAddressMapper;</span><br><span class="line"></span><br><span class="line">@Service <span class="comment">//使用dubbo提供的service注解，注册暴露服务</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="title">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	UserAddressMapper userAddressMapper;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、服务消费方</span><br><span class="line">&lt;dubbo:application name=<span class="string">&quot;gmall-order-web&quot;</span>&gt;&lt;/dubbo:application&gt;</span><br><span class="line">&lt;dubbo:registry address=<span class="string">&quot;zookeeper://118.24.44.169:2181&quot;</span> /&gt;</span><br><span class="line">&lt;dubbo:annotation package=<span class="string">&quot;com.atguigu.gmall.order.controller&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> gmall.bean.UserAddress;</span><br><span class="line"><span class="keyword">import</span> gmall.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> gmall.service.UserService;</span><br><span class="line">@Controller</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	@Reference  <span class="comment">//使用dubbo提供的reference注解引用远程服务</span></span><br><span class="line">	UserService userService;</span><br><span class="line">	</span><br><span class="line">  @Override</span><br><span class="line">    public List&lt;UserAddress&gt; <span class="function"><span class="title">initOrder</span>(<span class="params"><span class="built_in">String</span> userId</span>)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;用户id:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">// 1、查询用户收获地址</span></span><br><span class="line">        List&lt;UserAddress&gt; userAddressList = userService.getUserAddressList(userId);</span><br><span class="line">        <span class="keyword">return</span> userAddressList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5、监控中心"><a href="#5、监控中心" class="headerlink" title="5、监控中心"></a>5、监控中心</h3><p>5.1、dubbo-admin</p>
<p>图形化的服务管理页面；安装时需要指定注册中心地址，即可从注册中心中获取到所有的提供者/消费者进行配置管理</p>
<p>5.2、dubbo-monitor-simple</p>
<p>简单的监控中心；</p>
<p>1)、安装</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、下载 dubbo-ops</span><br><span class="line">https:<span class="comment">//github.com/apache/incubator-dubbo-ops</span></span><br><span class="line"><span class="number">2</span>、修改配置指定注册中心地址</span><br><span class="line">进入 dubbo-monitor-simple\src\main\resources\conf</span><br><span class="line">修改 dubbo.properties文件</span><br><span class="line"><span class="number">3</span>、打包dubbo-monitor-simple</span><br><span class="line">mvn clean package -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line"><span class="number">4</span>、解压 tar.gz 文件，并运行start.bat</span><br><span class="line">如果缺少servlet-api，自行导入servlet-api再访问监控中心</span><br><span class="line"><span class="number">5</span>、启动访问<span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p>2)、监控中心配置</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">所有服务配置连接监控中心，进行监控统计</span><br><span class="line">&lt;!-- 监控中心协议，如果为protocol=<span class="string">&quot;registry&quot;</span>，表示从注册中心发现监控中心地址，否则直连监控中心 --&gt;</span><br><span class="line">&lt;dubbo:monitor protocol=<span class="string">&quot;registry&quot;</span>&gt;&lt;/dubbo:monitor&gt;</span><br></pre></td></tr></table></figure>
<p>Simple Monitor 挂掉不会影响到 Consumer 和 Provider 之间的调用，所以用于生产环境不会有风险。</p>
<p>Simple Monitor 采用磁盘存储统计信息，请注意安装机器的磁盘限制，如果要集群，建议用mount共享磁盘。</p>
<h3 id="6、SpringBoot-整合-Dubbo"><a href="#6、SpringBoot-整合-Dubbo" class="headerlink" title="6、SpringBoot 整合 Dubbo"></a>6、SpringBoot 整合 Dubbo</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- SpringBoot版本 --&gt;</span><br><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.0</span><span class="number">.4</span>.RELEASE&lt;/version&gt;</span><br><span class="line">    &lt;relativePath/&gt; &lt;!-- lookup parent <span class="keyword">from</span> repository --&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- JDK <span class="number">1.8</span>--&gt;</span><br><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;java.version&gt;<span class="number">1.8</span>&lt;/java.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 引入公共接口项目--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;gmall-interface&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>6.1、引入spring-boot-starter以及dubbo和curator的依赖</p>
<p>注意starter版本适配：</p>
<p><img src="Untitled%2010.png" alt="Untitled%2010.png"></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Dubbo Spring Boot Starter --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.alibaba.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;<span class="number">0.2</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>6.2、配置application.properties</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、提供者配置</span><br><span class="line">#dubbo服务名称</span><br><span class="line">dubbo.application.name=boot-order-service-provider</span><br><span class="line">#注册中心地址</span><br><span class="line">dubbo.registry.address=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2181</span></span><br><span class="line">#注册中心协议</span><br><span class="line">dubbo.registry.protocol=zookeeper</span><br><span class="line">#通信协议</span><br><span class="line">dubbo.protocol.name=dubbo</span><br><span class="line">dubbo.protocol.prot=<span class="number">20880</span></span><br><span class="line">#监控中心地址:registry从注册中心自动发现</span><br><span class="line">dubbo.monitor.protocol=registry</span><br><span class="line">#application.name就是服务名，不能跟别的dubbo提供端重复</span><br><span class="line">#registry.protocol 是指定注册中心协议</span><br><span class="line">#registry.address 是注册中心的地址加端口号</span><br><span class="line">#protocol.name 是分布式固定是dubbo,不要改。</span><br><span class="line">#base-package  注解方式要扫描的包</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、消费者配置</span><br><span class="line">dubbo.application.name=gmall-order-web</span><br><span class="line">dubbo.registry.protocol=zookeeper</span><br><span class="line">dubbo.registry.address=<span class="number">192.168</span><span class="number">.67</span><span class="number">.159</span>:<span class="number">2181</span></span><br><span class="line">dubbo.scan.base-package=com.atguigu.gmall</span><br><span class="line">dubbo.protocol.name=dubbo</span><br></pre></td></tr></table></figure>
<p>3、dubbo注解</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#提供者:实现类开放服务</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</span><br><span class="line">@Service</span><br><span class="line"></span><br><span class="line">#消费者:从注册中心自动获取可用的实现服务</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</span><br><span class="line">@Reference</span><br><span class="line"></span><br><span class="line">如果没有在配置中写dubbo.scan.base-package,还需要使用@EnableDubbo注解</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.spring.context.annotation.EnableDubbo;</span><br><span class="line">@EnableDubbo</span><br></pre></td></tr></table></figure>
<h1 id="二、dubbo配置"><a href="#二、dubbo配置" class="headerlink" title="二、dubbo配置"></a>二、dubbo配置</h1><h2 id="1、配置原则"><a href="#1、配置原则" class="headerlink" title="1、配置原则"></a>1、配置原则</h2><p><img src="Untitled%2011.png" alt="Untitled%2011.png"></p>
<p>JVM 启动 -D 参数优先，这样可以使用户在部署和启动时进行参数重写，比如在启动时需改变协议的端口。</p>
<p>XML /applicatoin.properties次之，如果在 XML 中有配置，则 dubbo.properties 中的相应配置项无效。(自己测试结果为dubbo.properties 比XML/application.properties高)</p>
<p>Properties 最后，相当于缺省值，只有 XML 没有配置时，dubbo.properties 的相应配置项才会生效，通常用于共享公共配置，比如应用名。</p>
<p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docsv2.7/user/examples/preflight-check/">https://dubbo.apache.org/zh/docsv2.7/user/examples/preflight-check/</a></p>
<p><strong>启动时检查：</strong></p>
<p>Dubbo 缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止 Spring 初始化完成，以便上线时，能及早发现问题，默认 <code>check=&quot;true&quot;</code>。</p>
<p>可以通过 <code>check=&quot;false&quot;</code> 关闭检查，比如，测试时，有些服务不关心，或者出现了循环依赖，必须有一方先启动。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-D</span><br><span class="line">java -Ddubbo.reference.com.foo.BarService.check=<span class="literal">false</span></span><br><span class="line">java -Ddubbo.reference.check=<span class="literal">false</span></span><br><span class="line">java -Ddubbo.consumer.check=<span class="literal">false</span> </span><br><span class="line">java -Ddubbo.registry.check=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">XML</span><br><span class="line">&lt;dubbo:reference interface=<span class="string">&quot;com.foo.BarService&quot;</span> check=<span class="string">&quot;false&quot;</span> /&gt;</span><br><span class="line">&lt;dubbo:consumer check=<span class="string">&quot;false&quot;</span> /&gt;</span><br><span class="line">&lt;dubbo:registry check=<span class="string">&quot;false&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">dubbo.properties</span><br><span class="line">dubbo.reference.com.foo.BarService.check=<span class="literal">false</span></span><br><span class="line">dubbo.reference.check=<span class="literal">false</span></span><br><span class="line">dubbo.consumer.check=<span class="literal">false</span></span><br><span class="line">dubbo.registry.check=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h2 id="2、重试次数"><a href="#2、重试次数" class="headerlink" title="2、重试次数"></a>2、重试次数</h2><p>失败自动切换，当出现失败，重试其它服务器，但重试会带来更长延迟。可通过 retries=”2” 来设置重试次数(不含第一次)。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">重试次数配置如下：</span><br><span class="line">&lt;dubbo:service retries=<span class="string">&quot;2&quot;</span> /&gt;</span><br><span class="line">或</span><br><span class="line">&lt;dubbo:reference retries=<span class="string">&quot;2&quot;</span> /&gt;</span><br><span class="line">或</span><br><span class="line">&lt;dubbo:reference&gt;</span><br><span class="line">    &lt;dubbo:method name=<span class="string">&quot;findFoo&quot;</span> retries=<span class="string">&quot;2&quot;</span> /&gt;</span><br><span class="line">&lt;/dubbo:reference&gt;</span><br></pre></td></tr></table></figure>
<h2 id="3、超时时间"><a href="#3、超时时间" class="headerlink" title="3、超时时间"></a>3、超时时间</h2><p>由于网络或服务端不可靠，会导致调用出现一种不确定的中间状态（超时）。为了避免超时导致客户端资源（线程）挂起耗尽，必须设置超时时间.</p>
<p>3.1、消费端</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">全局超时配置</span><br><span class="line">&lt;dubbo:consumer timeout=<span class="string">&quot;5000&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">指定接口以及特定方法超时配置</span><br><span class="line">&lt;dubbo:reference interface=<span class="string">&quot;com.foo.BarService&quot;</span> timeout=<span class="string">&quot;2000&quot;</span>&gt;</span><br><span class="line">    &lt;dubbo:method name=<span class="string">&quot;sayHello&quot;</span> timeout=<span class="string">&quot;3000&quot;</span> /&gt;</span><br><span class="line">&lt;/dubbo:reference&gt;</span><br></pre></td></tr></table></figure>
<p>3.2、提供方</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">全局超时配置</span><br><span class="line">&lt;dubbo:provider timeout=<span class="string">&quot;5000&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">指定接口以及特定方法超时配置</span><br><span class="line">&lt;dubbo:provider interface=<span class="string">&quot;com.foo.BarService&quot;</span> timeout=<span class="string">&quot;2000&quot;</span>&gt;</span><br><span class="line">    &lt;dubbo:method name=<span class="string">&quot;sayHello&quot;</span> timeout=<span class="string">&quot;3000&quot;</span> /&gt;</span><br><span class="line">&lt;/dubbo:provider&gt;</span><br></pre></td></tr></table></figure>
<p>3.3、配置规则</p>
<p>Dubbo推荐在Provider上尽量多配置Consumer端属性</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、作服务的提供者，比服务使用方更清楚服务性能参数，如调用的超时时间，合理的重试次数，等等</span><br><span class="line"><span class="number">2</span>、在Provider配置后，Consumer不配置则会使用Provider的配置值，即Provider配置可以作为Consumer的缺省值。否则，Consumer会使用Consumer端的全局设置，这对于Provider不可控的，并且往往是不合理的</span><br></pre></td></tr></table></figure>
<p>配置的覆盖规则：</p>
<ol>
<li><p>方法级配置别优于接口级别，即小Scope优先</p>
</li>
<li><p>Consumer端配置 优于 Provider配置 优于 全局配置，</p>
</li>
</ol>
<p>3) 最后是缺省值（见配置文档）</p>
<h2 id="4、版本号"><a href="#4、版本号" class="headerlink" title="4、版本号"></a>4、版本号</h2><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docsv2.7/user/examples/multi-versions/">https://dubbo.apache.org/zh/docsv2.7/user/examples/multi-versions/</a></p>
<p>当一个接口实现，出现不兼容升级时，可以用版本号过渡，版本号不同的服务相互间不引用。可以按照以下的步骤进行版本迁移：</p>
<p>在低压力时间段，先升级一半提供者为新版本</p>
<p>再将所有消费者升级为新版本</p>
<p>然后将剩下的一半提供者升级为新版本</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">服务老版本提供者配置：</span><br><span class="line">&lt;dubbo:service interface=<span class="string">&quot;com.foo.BarService&quot;</span> version=<span class="string">&quot;1.0.0&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">服务新版本提供者配置：</span><br><span class="line">&lt;dubbo:service interface=<span class="string">&quot;com.foo.BarService&quot;</span> version=<span class="string">&quot;2.0.0&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">服务老版本消费者配置：</span><br><span class="line">&lt;dubbo:reference id=<span class="string">&quot;barService&quot;</span> interface=<span class="string">&quot;com.foo.BarService&quot;</span> version=<span class="string">&quot;1.0.0&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">新版本服务消费者配置：</span><br><span class="line">&lt;dubbo:reference id=<span class="string">&quot;barService&quot;</span> interface=<span class="string">&quot;com.foo.BarService&quot;</span> version=<span class="string">&quot;2.0.0&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">如果不需要区分版本，可以按照以下的方式配置：</span><br><span class="line">&lt;dubbo:reference id=<span class="string">&quot;barService&quot;</span> interface=<span class="string">&quot;com.foo.BarService&quot;</span> version=<span class="string">&quot;*&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<h2 id="5、本地存根"><a href="#5、本地存根" class="headerlink" title="5、本地存根"></a>5、本地存根</h2><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docsv2.7/user/examples/local-stub/">https://dubbo.apache.org/zh/docsv2.7/user/examples/local-stub/</a></p>
<p>远程服务后，客户端通常只剩下接口，而实现全在服务器端，但提供方有些时候想在客户端也执行部分逻辑，比如：做 ThreadLocal 缓存，提前验证参数，调用失败后伪造容错数据等等，此时就需要在 API 中带上 Stub，客户端生成 Proxy 实例，会把 Proxy 通过构造函数传给 Stub <a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docsv2.7/user/examples/local-stub/#fn:1">1</a>，然后把 Stub 暴露给用户，Stub 可以决定要不要去调 Proxy。</p>
<p><img src="stub.jpg" alt="stub.jpg"></p>
<p>在消费方，写一个远程接口本地的实现，提供 Stub 的实现 ：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.foo;</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">BarServiceStub</span> <span class="title">implements</span> <span class="title">BarService</span> </span>&#123;</span><br><span class="line">    private final BarService barService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 必须有一个有参构造，并且使构造函数传入真正的远程代理对象</span></span><br><span class="line">    public <span class="function"><span class="title">BarServiceStub</span>(<span class="params">BarService barService</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.barService = barService;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">sayHello</span>(<span class="params"><span class="built_in">String</span> name</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 此代码在客户端执行, 你可以在客户端做ThreadLocal本地缓存，或预先验证参数是否合法，等等</span></span><br><span class="line">        <span class="comment">// ...自己的代码</span></span><br><span class="line">				<span class="comment">// 当自己代码执行结束后，再调真正的远程服务</span></span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> barService.sayHello(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 你可以容错，可以做任何AOP拦截事项</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;容错数据&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 spring 配置文件中按以下方式配置：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">提供者方配置</span><br><span class="line">&lt;dubbo:service interface=<span class="string">&quot;com.foo.BarService&quot;</span> stub=<span class="string">&quot;true&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">消费者方配置</span><br><span class="line">&lt;dubbo:reference interface=<span class="string">&quot;gmall.service.UserService&quot;</span></span><br><span class="line">  id=<span class="string">&quot;userService&quot;</span> timeout=<span class="string">&quot;5000&quot;</span> retries=<span class="string">&quot;3&quot;</span> version=<span class="string">&quot;*&quot;</span> </span><br><span class="line">	stub=<span class="string">&quot;com.atguigu.gmall.service.impl.UserServiceStub&quot;</span>&gt;</span><br><span class="line">&lt;dubbo:method name=<span class="string">&quot;getUserAddressList&quot;</span> timeout=<span class="string">&quot;1000&quot;</span>/&gt;</span><br><span class="line">&lt;/dubbo:reference&gt;</span><br></pre></td></tr></table></figure>
<hr>
<ol>
<li>Stub 必须有可传入 Proxy 的构造函数。 </li>
<li>在 interface 旁边放一个 Stub 实现，它实现 BarService 接口，并有一个传入远程 BarService 实例的构造函数 </li>
</ol>
<h2 id="6、SpringBoot方式配置"><a href="#6、SpringBoot方式配置" class="headerlink" title="6、SpringBoot方式配置"></a>6、SpringBoot方式配置</h2><h3 id="6-1、超时属性"><a href="#6-1、超时属性" class="headerlink" title="6.1、超时属性"></a>6.1、超时属性</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</span><br><span class="line">@Service(timeout)</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</span><br><span class="line">@Reference(timeout = <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h3 id="6-2、SpringBoot与Dubbo整合的三种方式"><a href="#6-2、SpringBoot与Dubbo整合的三种方式" class="headerlink" title="6.2、SpringBoot与Dubbo整合的三种方式"></a>6.2、SpringBoot与Dubbo整合的三种方式</h3><p><strong>6.2.1、第一种</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>导入dobuuo-starter</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.alibaba.boot&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">0.2</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>配置application.properties</span><br><span class="line">#dubbo服务名称</span><br><span class="line">dubbo.application.name=boot-order-service-provider</span><br><span class="line">#注册中心地址</span><br><span class="line">dubbo.registry.address=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2181</span></span><br><span class="line">#注册中心协议</span><br><span class="line">dubbo.registry.protocol=zookeeper</span><br><span class="line">#通信协议</span><br><span class="line">dubbo.protocol.name=dubbo</span><br><span class="line">dubbo.protocol.prot=<span class="number">20880</span></span><br><span class="line">#监控中心地址:registry从注册中心自动发现</span><br><span class="line">dubbo.monitor.protocol=registry</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>暴漏服务注解@Service</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>使用远程服务@Reference</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>开启Dubbo注解功能@EnableDubbo</span><br><span class="line"></span><br><span class="line">#老版本会指定包扫描规则</span><br><span class="line">dubbo.scan.base-packages=com</span><br></pre></td></tr></table></figure>
<p><strong>6.2.2、第二种：保留XML</strong></p>
<p>想要做到方法级别的配置，保留dubbo的xml配置文件，之后可以在xml中做到method方法级别的配置。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 拷贝xml文件到resource目录,删除application.properties中dubbo的相关配置</span><br><span class="line"># 所有配置都在xml中</span><br><span class="line"><span class="number">1.</span>导入dobuuo-starter</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.alibaba.boot&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">0.2</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>使用@ImportResource导入dubbo的xml配置文件</span><br><span class="line"><span class="comment">//@EnableDubbo</span></span><br><span class="line">@ImportResource(location=<span class="string">&quot;classpath:provider.xml&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>6.2.3、第三种:注解API配置类</strong></p>
<p>将每一个组件手动创建到容器中</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>创建配置类</span><br><span class="line">package com.atguigu.gmall.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.*;</span><br><span class="line"><span class="keyword">import</span> gmall.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyDubboConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供者名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Bean</span><br><span class="line">    public ApplicationConfig <span class="function"><span class="title">applicationConfig</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ApplicationConfig applicationConfig = <span class="keyword">new</span> ApplicationConfig();</span><br><span class="line">        applicationConfig.setName(<span class="string">&quot;boot-order-service-provider-config&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> applicationConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册中心地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Bean</span><br><span class="line">    public RegistryConfig <span class="function"><span class="title">registryConfig</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        RegistryConfig registryConfig = <span class="keyword">new</span> RegistryConfig();</span><br><span class="line">        registryConfig.setProtocol(<span class="string">&quot;zookeeper&quot;</span>);</span><br><span class="line">        registryConfig.setAddress(<span class="string">&quot;127.0.0.1:2181&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> registryConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通信规则</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Bean</span><br><span class="line">    public ProtocolConfig <span class="function"><span class="title">protocolConfig</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        ProtocolConfig protocolConfig = <span class="keyword">new</span> ProtocolConfig();</span><br><span class="line">        protocolConfig.setName(<span class="string">&quot;dubbo&quot;</span>);</span><br><span class="line">        protocolConfig.setPort(<span class="number">20882</span>);</span><br><span class="line">        <span class="keyword">return</span> protocolConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置暴漏服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Bean</span><br><span class="line">    public ServiceConfig&lt;UserService&gt; <span class="function"><span class="title">userServiceConfig</span>(<span class="params">UserService userService</span>)</span> &#123;</span><br><span class="line">        ServiceConfig&lt;UserService&gt; userServiceConfig = <span class="keyword">new</span> ServiceConfig&lt;&gt;();</span><br><span class="line">        <span class="comment">//配置接口级别</span></span><br><span class="line">        userServiceConfig.setInterface(UserService.class);</span><br><span class="line">        userServiceConfig.setRef(userService);</span><br><span class="line">        userServiceConfig.setVersion(<span class="string">&quot;1.0.0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置方法级别</span></span><br><span class="line">        MethodConfig methodConfig = <span class="keyword">new</span> MethodConfig();</span><br><span class="line">        methodConfig.setName(<span class="string">&quot;getUserAddressList&quot;</span>);</span><br><span class="line">        methodConfig.setTimeout(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        userServiceConfig.setMethods(Arrays.asList(methodConfig));</span><br><span class="line">        <span class="keyword">return</span> userServiceConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置监控中心</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Bean</span><br><span class="line">    public MonitorConfig <span class="function"><span class="title">monitorConfig</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        MonitorConfig monitorConfig = <span class="keyword">new</span> MonitorConfig();</span><br><span class="line">        monitorConfig.setProtocol(<span class="string">&quot;registry&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> monitorConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>暴露服务接口</span><br><span class="line">@Service <span class="comment">//暴露服务</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>启动dubbo并指定扫描路径</span><br><span class="line">@EnableDubbo(scanBasePackages = <span class="string">&quot;com.atguigu.gmall&quot;</span>)</span><br></pre></td></tr></table></figure>
<h1 id="三、高可用"><a href="#三、高可用" class="headerlink" title="三、高可用"></a>三、高可用</h1><h2 id="3-1、zookeeper宕机与dubbo直连"><a href="#3-1、zookeeper宕机与dubbo直连" class="headerlink" title="3.1、zookeeper宕机与dubbo直连"></a>3.1、zookeeper宕机与dubbo直连</h2><p><img src="Untitled%2012.png" alt="Untitled%2012.png"></p>
<p>注册中心的作用就是保存服务提供者位置信息，我们完全可以绕过注册中心使用dubbo直连.</p>
<p>宕机了有缓存，依旧可以调用。没有注册中心使用直连</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Reference(timeout = <span class="number">0</span>,url = <span class="string">&quot;127.0.0.1:20880&quot;</span>)</span><br><span class="line">UserService userService;</span><br></pre></td></tr></table></figure>
<h2 id="3-2、集群下dubbo负载均衡机制"><a href="#3-2、集群下dubbo负载均衡机制" class="headerlink" title="3.2、集群下dubbo负载均衡机制"></a>3.2、集群下dubbo负载均衡机制</h2><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docsv2.7/user/examples/loadbalance/">https://dubbo.apache.org/zh/docsv2.7/user/examples/loadbalance/</a></p>
<p>在集群负载均衡时，Dubbo 提供了多种均衡策略，缺省为 random 随机调用,</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">**Random LoadBalance**</span><br><span class="line">随机，按权重设置随机概率。</span><br><span class="line">在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。</span><br><span class="line">**RoundRobin LoadBalance**</span><br><span class="line">轮循，按公约后的权重设置轮循比率。</span><br><span class="line">存在慢的提供者累积请求的问题，比如：第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上。</span><br><span class="line">**LeastActive LoadBalance**</span><br><span class="line">最少活跃调用数，相同活跃数的随机，活跃数指调用前后计数差。</span><br><span class="line">使慢的提供者收到更少请求，因为越慢的提供者的调用前后计数差会越大。</span><br><span class="line">**ConsistentHash LoadBalance**</span><br><span class="line">一致性 Hash，相同参数的请求总是发到同一提供者。</span><br><span class="line">当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。算法参见：http:<span class="comment">//en.wikipedia.org/wiki/Consistent_hashing</span></span><br><span class="line">缺省只对第一个参数 Hash，如果要修改，请配置 &lt;dubbo:parameter key=<span class="string">&quot;hash.arguments&quot;</span> value=<span class="string">&quot;0,1&quot;</span> /&gt;</span><br><span class="line">缺省用 <span class="number">160</span> 份虚拟节点，如果要修改，请配置 &lt;dubbo:parameter key=<span class="string">&quot;hash.nodes&quot;</span> value=<span class="string">&quot;320&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-1、Random-LoadBalance"><a href="#3-2-1、Random-LoadBalance" class="headerlink" title="3.2.1、Random LoadBalance"></a>3.2.1、Random LoadBalance</h3><p><img src="Untitled%2013.png" alt="Untitled%2013.png"></p>
<h3 id="3-2-2、RoundRobin-LoadBalance"><a href="#3-2-2、RoundRobin-LoadBalance" class="headerlink" title="3.2.2、RoundRobin LoadBalance"></a>3.2.2、RoundRobin LoadBalance</h3><p>第一调完，必须去第二个,根据权重1只能占2次，2占4次，3占1次。</p>
<p><img src="Untitled%2014.png" alt="Untitled%2014.png"></p>
<h3 id="3-2-3、LeastActive-LoadBalance"><a href="#3-2-3、LeastActive-LoadBalance" class="headerlink" title="3.2.3、LeastActive LoadBalance"></a>3.2.3、LeastActive LoadBalance</h3><p><img src="Untitled%2015.png" alt="Untitled%2015.png"></p>
<p>每次都统计上次请求时间</p>
<p>调哪个前会查那个上次最快</p>
<h3 id="3-2-4、ConsistentHash-LoadBalance"><a href="#3-2-4、ConsistentHash-LoadBalance" class="headerlink" title="3.2.4、ConsistentHash LoadBalance"></a>3.2.4、ConsistentHash LoadBalance</h3><p>比如getUser,id都等于1的，根据hash分布都会来到1号机器。</p>
<p><img src="Untitled%2016.png" alt="Untitled%2016.png"></p>
<h3 id="3-2-5、配置"><a href="#3-2-5、配置" class="headerlink" title="3.2.5、配置"></a>3.2.5、配置</h3><p>默认为随机负载均衡机制</p>
<p><img src="Untitled%2017.png" alt="Untitled%2017.png"></p>
<p><img src="Untitled%2018.png" alt="Untitled%2018.png"></p>
<p>XML：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">### **服务端服务级别**</span><br><span class="line"></span><br><span class="line"><span class="string">`&lt;dubbo:service interface=&quot;...&quot; loadbalance=&quot;roundrobin&quot; /&gt;`</span></span><br><span class="line"></span><br><span class="line">### **客户端服务级别**</span><br><span class="line"></span><br><span class="line"><span class="string">`&lt;dubbo:reference interface=&quot;...&quot; loadbalance=&quot;roundrobin&quot; /&gt;`</span></span><br><span class="line"></span><br><span class="line">### **服务端方法级别**</span><br><span class="line"></span><br><span class="line"><span class="string">`&lt;dubbo:service interface=&quot;...&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;dubbo:method name=&quot;...&quot; loadbalance=&quot;roundrobin&quot;/&gt;</span></span><br><span class="line"><span class="string">&lt;/dubbo:service&gt;`</span></span><br><span class="line"></span><br><span class="line">### **客户端方法级别**</span><br><span class="line"></span><br><span class="line"><span class="string">`&lt;dubbo:reference interface=&quot;...&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;dubbo:method name=&quot;...&quot; loadbalance=&quot;roundrobin&quot;/&gt;</span></span><br><span class="line"><span class="string">&lt;/dubbo:reference&gt;`</span></span><br></pre></td></tr></table></figure>
<p>注解：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Reference(timeout = <span class="number">0</span>,loadbalance = <span class="string">&quot;roundrobin&quot;</span>) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="Untitled%2019.png" alt="Untitled%2019.png"></p>
<h2 id="3-3、整合hystrix，服务熔断与降级处理"><a href="#3-3、整合hystrix，服务熔断与降级处理" class="headerlink" title="3.3、整合hystrix，服务熔断与降级处理"></a>3.3、整合hystrix，服务熔断与降级处理</h2><h3 id="3-3-1、服务降级"><a href="#3-3-1、服务降级" class="headerlink" title="3.3.1、服务降级"></a>3.3.1、服务降级</h3><p>什么是服务降级？</p>
<p>当服务器压力剧增的情况下，根据实际业务情况及流量，对一些服务和页面有策略的不处理或换种简单的方式处理，从而释放服务器资源以保证核心交易正常运作或高效运作</p>
<p>可以通过服务降级功能临时屏蔽某个出错的非关键服务，并定义降级后的返回策略。</p>
<p>支持2种：</p>
<ul>
<li>mock=force:return+null 表示消费方对该服务的方法调用都直接返回 null 值，不发起远程调用。用来屏蔽不重要服务不可用时对调用方的影响。（直接在客户端返回null，不发起远程调用）</li>
<li>还可以改为 mock=fail:return+null 表示消费方对该服务的方法调用在失败后，再返回 null 值，不抛异常。用来容忍不重要服务不稳定时对调用方的影响。（到达一定超时时间，超时后调用在失败后，再返回 null 值，这个是服务已经调用了）</li>
</ul>
<p>通过服务降级手段，牺牲非核心业务的占用的资源，达到让其他核心业务能占用服务器更多资源</p>
<p><strong>配置，在消费者端</strong></p>
<p>第一种：屏蔽（不进行远程调用，返回null）</p>
<p><img src="Untitled%2020.png" alt="Untitled%2020.png"></p>
<p>第二种：容错（当远程调用失败后，返回null）</p>
<p><img src="Untitled%2021.png" alt="Untitled%2021.png"></p>
<h3 id="3-3-2、集群容错"><a href="#3-3-2、集群容错" class="headerlink" title="3.3.2、集群容错"></a>3.3.2、集群容错</h3><p>在集群调用失败时，Dubbo 提供了多种容错方案，缺省为 failover 重试。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>**Failover Cluster**</span><br><span class="line">失败自动切换，当出现失败，重试其它服务器。通常**用于读操作**，但重试会带来更长延迟。</span><br><span class="line">可通过 retries=<span class="string">&quot;2&quot;</span> 来设置重试次数(不含第一次)。</span><br><span class="line"></span><br><span class="line">重试次数配置如下：</span><br><span class="line">&lt;dubbo:service retries=<span class="string">&quot;2&quot;</span> /&gt;</span><br><span class="line">或</span><br><span class="line">&lt;dubbo:reference retries=<span class="string">&quot;2&quot;</span> /&gt;</span><br><span class="line">或</span><br><span class="line">&lt;dubbo:reference&gt;</span><br><span class="line">    &lt;dubbo:method name=<span class="string">&quot;findFoo&quot;</span> retries=<span class="string">&quot;2&quot;</span> /&gt;</span><br><span class="line">&lt;/dubbo:reference&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>**Failfast Cluster**</span><br><span class="line">快速失败，只发起一次调用，失败立即报错。通常用于**非幂等性**的写操作，比如新增记录。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>**Failsafe Cluster**</span><br><span class="line">失败安全，出现异常时，直接**忽略**。通常用于写入审计日志等操作。</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>**Failback Cluster**</span><br><span class="line">**失败自动恢复**，后台记录失败请求，定时重发。通常**用于消息通知**操作。</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>**Forking Cluster**</span><br><span class="line">**并行调用**多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，</span><br><span class="line">但需要浪费更多服务资源。可通过 forks=<span class="string">&quot;2&quot;</span> 来设置最大并行数。太浪费资源。</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>**Broadcast Cluster**</span><br><span class="line">广播**调用所有提供者，逐个调用，任意一台报错则报错** [<span class="number">2</span>]。</span><br><span class="line">通常**用于通知所有提供者更新缓存**或日志等本地资源信息。</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>**集群模式配置**</span><br><span class="line">按照以下示例在服务提供方和消费方配置集群模式</span><br><span class="line">&lt;dubbo:service cluster=<span class="string">&quot;failsafe&quot;</span> /&gt;</span><br><span class="line">或</span><br><span class="line">&lt;dubbo:reference cluster=<span class="string">&quot;failsafe&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-3、实际开发整合hystrix提供容错（SpringCloud默认整合的框架）"><a href="#3-3-3、实际开发整合hystrix提供容错（SpringCloud默认整合的框架）" class="headerlink" title="3.3.3、实际开发整合hystrix提供容错（SpringCloud默认整合的框架）"></a>3.3.3、实际开发整合hystrix提供容错（SpringCloud默认整合的框架）</h3><p>Hystrix 旨在通过控制那些访问远程系统、服务和第三方库的节点，从而对延迟和故障提供更强大的容错能力。Hystrix具备拥有回退机制和断路器功能的线程和信号隔离，请求缓存和请求打包，以及监控和配置等功能。</p>
<p><strong>1、配置spring-cloud-starter-netflix-hystrix</strong></p>
<p>spring boot官方提供了对hystrix的集成，直接在消费者、提供者的pom.xml里加入依赖：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">1.4</span><span class="number">.4</span>.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>然后在Application类上增加@EnableHystrix来启用hystrix starter：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableHystrix</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ProviderApplication</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2、配置Provider端</strong></p>
<p>在Dubbo的Provider上增加@HystrixCommand配置，这样子调用就会经过Hystrix代理。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Service(version = <span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceImpl</span> <span class="title">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line">		<span class="comment">//使用Hystrix代理，进行处理容错异常</span></span><br><span class="line">    @HystrixCommand(commandProperties = &#123;</span><br><span class="line">     @HystrixProperty(name = <span class="string">&quot;circuitBreaker.requestVolumeThreshold&quot;</span>, value = <span class="string">&quot;10&quot;</span>),</span><br><span class="line">     @HystrixProperty(name = <span class="string">&quot;execution.isolation.thread.timeoutInMilliseconds&quot;</span>, value = <span class="string">&quot;2000&quot;</span>) &#125;)</span><br><span class="line">    @Override</span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">sayHello</span>(<span class="params"><span class="built_in">String</span> name</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// System.out.println(&quot;async provider received: &quot; + name);</span></span><br><span class="line">        <span class="comment">// return &quot;annotation: hello, &quot; + name;</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Exception to show hystrix enabled.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3、配置Consumer端</strong></p>
<p>对于Consumer端，则可以增加一层method调用，并在method上配置@HystrixCommand。当调用出错时，会走到fallbackMethod = “reliable”的调用里。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Reference(version = <span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">    private HelloService demoService;</span><br><span class="line">		<span class="comment">//fallbackMethod 回调方法,一旦调用失败出错后，调用reliable方法</span></span><br><span class="line">		<span class="comment">//就不用在调用代码中trycatch了</span></span><br><span class="line">    @HystrixCommand(fallbackMethod = <span class="string">&quot;reliable&quot;</span>)</span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">doSayHello</span>(<span class="params"><span class="built_in">String</span> name</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> demoService.sayHello(name);</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="built_in">String</span> <span class="function"><span class="title">reliable</span>(<span class="params"><span class="built_in">String</span> name</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hystrix fallback value&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="四、Dubbo原理"><a href="#四、Dubbo原理" class="headerlink" title="四、Dubbo原理"></a>四、Dubbo原理</h1><h2 id="4-1、RPC原理"><a href="#4-1、RPC原理" class="headerlink" title="4.1、RPC原理"></a>4.1、RPC原理</h2><p>rpc就是想完成一次远程调用</p>
<p><img src="Untitled%2022.png" alt="Untitled%2022.png"></p>
<p>一次完整的RPC调用流程（同步调用，异步另说）如下：</p>
<p>1）Computer01（client）发起远程调用请求,接下来有一个代理对象client stub</p>
<p><strong>2）client stub接收到调用后负责将方法、参数等组装成能够进行网络传输的消息体；</strong></p>
<p><strong>3）client stub找到服务地址，并将消息发送到服务端server stub；</strong></p>
<p><strong>4）server stub收到消息后进行解码(可能传输的是序列化对象，需要反序列化)；</strong></p>
<p><strong>5）server stub根据解码结果调用本地的方法服务；</strong></p>
<p><strong>6）本地方法服务执行完成后，将数据结果返回给server stub；</strong></p>
<p><strong>7）server stub将返回结果打包(序列化)成消息通过网络发送至消费方client stub；</strong></p>
<p><strong>8）client stub接收到消息，并进行解码(反序列化)；</strong></p>
<p>9）服务消费方Computer01得到最终结果。</p>
<p>RPC框架的目标就是要2~8这些步骤都封装起来，这些细节对用户来说是透明的，不可见的。</p>
<h2 id="4-2、netty通信原理"><a href="#4-2、netty通信原理" class="headerlink" title="4.2、netty通信原理"></a>4.2、netty通信原理</h2><p>Dubbo底层通信时是使用netty，Netty时基于Java的NIO(Non-Blocking IO)非阻塞,BIO(Blocking IO)阻塞IO。</p>
<p><strong>BIO：</strong></p>
<p><img src="Untitled%2023.png" alt="Untitled%2023.png"></p>
<p>每一个请求进来开一个线程Socket，读取Socket的输入流、进行业务逻辑等等。同时在这操作，并且此时在我们业务逻辑没完成之前，我们线程都不能得到释放的，这样我们的服务器就不能同时处理大量的请求。因为有大量的线程在等待业务逻辑的完成。</p>
<p><strong>NIO：</strong></p>
<p><img src="Untitled%2024.png" alt="Untitled%2024.png"></p>
<p>Channel：通道，通道里还有Buffer，利用Buffer进行数据传输。</p>
<p>Selector ：一般称 为<strong>选择器</strong> ，也可以翻译为 <strong>多路复用器。</strong></p>
<p>通道状态：Connect（连接就绪）、Accept（接受就绪）、Read（读就绪）、Write（写就绪）。</p>
<p><strong>基本原理：</strong></p>
<p>1个Selector会有很多通道注册了进来，Selector通过监听多个通道，监听会有很多事件，如当Connect了发生什么，Accept了会做什么，Read或Write发生了时要做什么，当发现某一个通道数据准备好了。所以我们通过1个Selector监听多个通道的方式，当某个通道任何一个状态准备好了，我们可以额外开一个线程进行处理。这叫多路复用模型。</p>
<p><img src="Untitled%2025.png" alt="Untitled%2025.png"></p>
<p>1.启动</p>
<p>2.监听某一个端口</p>
<p>3.初始化一个通道，注册到Selector中</p>
<p>4.轮询监听通道的accept事件</p>
<p>5.当accept事件发生后，扔到任务队列，处理通道信息，就与客户端建立连接来生成SocketChannel</p>
<p>6.然后把刚生成的SocketChannel通道再注册到Selector里面，进行监听read、wirte事件</p>
<p>7.read、wirte事件准备就绪了就来处理，抛给任务队列。</p>
<p>注意：有2个Selector，一个是boss来进行监听准备就绪事件，另一个woker是当准备就绪后要做什么工作，把这个工作抛给woker慢慢来做。</p>
<h2 id="4-3、dubbo原理"><a href="#4-3、dubbo原理" class="headerlink" title="4.3、dubbo原理"></a>4.3、dubbo原理</h2><h3 id="4-3-1、dubbo原理-框架设计"><a href="#4-3-1、dubbo原理-框架设计" class="headerlink" title="4.3.1、dubbo原理    -   框架设计"></a>4.3.1、dubbo原理    -   框架设计</h3><p><img src="Untitled%2026.png" alt="Untitled%2026.png"></p>
<p><strong>各层说明</strong></p>
<ul>
<li><strong>config 配置层</strong>：对外配置接口，以 <code>ServiceConfig</code>, <code>ReferenceConfig</code> 为中心，可以直接初始化配置类，也可以通过 spring 解析<strong>配置生成配置类</strong></li>
<li><strong>proxy 服务代理层</strong>：服务接口透明代理，<strong>生成服务的客户端 Stub 和服务器端 Skeleton,</strong> 以 <code>ServiceProxy</code> 为中心，扩展接口为 <code>ProxyFactory</code></li>
<li><strong>registry 注册中心层</strong>：封装服务地址的<strong>注册与发现</strong>，以服务 URL 为中心，扩展接口为 <code>RegistryFactory</code>, <code>Registry</code>, <code>RegistryService</code></li>
<li><strong>cluster 路由层</strong>：封装多个提供者的路由及<strong>负载均衡</strong>，并桥接注册中心，以 <code>Invoker</code> 为中心，扩展接口为 <code>Cluster</code>, <code>Directory</code>, <code>Router</code>, <code>LoadBalance</code></li>
<li><strong>monitor 监控层</strong>：RPC <strong>调用次数和调用时间监控</strong>，以 <code>Statistics</code> 为中心，扩展接口为 <code>MonitorFactory</code>, <code>Monitor</code>, <code>MonitorService</code></li>
<li><strong>protocol 远程调用层</strong>：<strong>封装 RPC 调用</strong>，以 <code>Invocation</code>, <code>Result</code> 为中心，扩展接口为 <code>Protocol</code>, <code>Invoker</code>, <code>Exporter</code></li>
<li><strong>exchange 信息交换层</strong>：封装请求响应模式，同步转异步，以 <code>Request</code>, <code>Response</code> 为中心，扩展接口为 <code>Exchanger</code>, <code>ExchangeChannel</code>, <code>ExchangeClient</code>, <code>ExchangeServer</code>，创建客户端和服务端，两个架起管道进行数据互联互通。</li>
<li><strong>transport 网络传输层</strong>：抽象 mina 和 **netty (transport 底层)**为统一接口，以 <code>Message</code> 为中心，扩展接口为 <code>Channel</code>, <code>Transporter</code>, <code>Client</code>, <code>Server</code>, <code>Codec</code></li>
<li><strong>serialize 数据序列化层</strong>：可复用的一些工具，扩展接口为 <code>Serialization</code>, <code>ObjectInput</code>, <code>ObjectOutput</code>, <code>ThreadPool</code></li>
</ul>
<p><strong>说明：</strong>Consumer在左边，Provider在右边。Call为调用逻辑，黑颜色是依赖顺序。</p>
<h3 id="4-3-2、dubbo原理-启动解析、加载配置信息"><a href="#4-3-2、dubbo原理-启动解析、加载配置信息" class="headerlink" title="4.3.2、dubbo原理    -   启动解析、加载配置信息"></a>4.3.2、dubbo原理    -   启动解析、加载配置信息</h3><p>BeanDefinitionParser定义解析器</p>
<p>DubboBeanDefinitionParser中的parse方法来解析标签。挨个标签来解析。</p>
<p>DubboBeanDefinitionParser构造器打断点看怎么创建出来的。</p>
<p><img src="Untitled%2027.png" alt="Untitled%2027.png"></p>
<p>init方法注册很多标签解析器。容器启动，解析每一个标签，每一个标签都有对应的***Config.class，保存到指定的对象中,Service标签牵扯到服务暴漏的功能。</p>
<p><img src="Untitled%2028.png" alt="Untitled%2028.png"></p>
<h3 id="4-3-3、dubbo原理-服务暴露"><a href="#4-3-3、dubbo原理-服务暴露" class="headerlink" title="4.3.3、dubbo原理    -   服务暴露"></a>4.3.3、dubbo原理    -   服务暴露</h3><p><img src="dubbo-%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2.jpg" alt="dubbo-%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2.jpg"></p>
<p>Service标签牵扯到服务暴漏的功能，ServiceBean它实现了InitalizingBean（它在创建完对象以后调用afterPropertisSet方法）、ApplicationListener(事件是ContextRefreshedEvent(当IOC容器完成后会回调onApplicationEvent方法))</p>
<p>afterPropertisSet方法和onApplicationEvent方法都做了什么：</p>
<p>afterPropertisSet方法保存配置的属性信息。</p>
<p>onApplicationEvent方法判断当没有爆露时调用export方法暴漏服务，调用doExport方法。调用doExportUrls方法，第一步加载注册信息，再调用doExportUrlsFor1Portocol方法，创建invoker，调用protocol(DubboProtocol).export(wrapperInvoker)</p>
<p>暴漏URL,OPENServer(url)，启动netty服务器，监听20880端口</p>
<p>创建服务器createServer(url)</p>
<p>Exchangers.bind(url,requestHandler)绑定url和处理器</p>
<p>Transporters.bind(url,new DecodeHandler(new HanderExchangesHandler()))这都是netty的底层，创建一个netty的服务器。</p>
<p>注册提供者。</p>
<p>总共2步：</p>
<p>启动netty服务器，监听20880端口。</p>
<p>注册中心进行注册服务，把注册好的地址，把注册信息保存在注册中心。</p>
<p>microkernel plugin模式</p>
<h3 id="4-3-4、dubbo原理-服务引用"><a href="#4-3-4、dubbo原理-服务引用" class="headerlink" title="4.3.4、dubbo原理    -   服务引用"></a>4.3.4、dubbo原理    -   服务引用</h3><p>如何通过配置reference标签远程引用暴漏的服务。</p>
<p><img src="Untitled%2029.png" alt="Untitled"></p>
<p>前置类似暴漏服务原理，对应的是ReferenceBean,特殊在implement FactoryBean，FactoryBean作用是当我们要获取userService，在引用userService的类中需要自动注入userService，需要从spring容器中找，通过调用FactoryBean的getObject方法获取userService对象，getObject调用ReferenceConfig的getT方法，如果ref引用是空的，就init（）初始化对象，ref = createProxy（map）。</p>
<p><img src="Untitled%2030.png" alt="Untitled"></p>
<p><img src="Untitled%2031.png" alt="Untitled"></p>
<p>然后远程引用接口，urls保存了注册中心的地址。</p>
<p><img src="Untitled%2032.png" alt="Untitled"></p>
<p>refprotocal还是Protocal，Protocal有2种，1个是DubboProtocal，另一个是RegistryProtocol，这里调用RegistryProtocol的refer方法。</p>
<p><img src="Untitled%2033.png" alt="Untitled"></p>
<p>先根据注册中心地址得到注册中心信息。然后调用doRefer,传入了注册中心地址，还有要引用的userService</p>
<p><img src="Untitled%2034.png" alt="Untitled"></p>
<p>之后进行订阅服务</p>
<p><img src="Untitled%2035.png" alt="Untitled"></p>
<p>订阅服务会进入到DubboProtocol，DubboProtocol会getClients获取客户端。</p>
<p><img src="Untitled%2036.png" alt="Untitled"></p>
<p>拿到客户端，初始化客户端</p>
<p><img src="Untitled%2037.png" alt="Untitled"></p>
<p>然偶会进行连接</p>
<p><img src="Untitled%2038.png" alt="Untitled"></p>
<p>获取返回连接，调用Transporter.connect（），之后就到达了netty的底层。</p>
<p><img src="Untitled%2039.png" alt="Untitled"></p>
<p><img src="Untitled%2040.png" alt="Untitled"></p>
<p><img src="Untitled%2041.png" alt="Untitled"></p>
<p>相当于创建一个netty客户端，根据url地址监听一个端口。创建完连接后返回DubboProtocol中，创建好invoker，返回invoker。</p>
<p><img src="Untitled%2042.png" alt="Untitled"></p>
<p>获取创建好的invoker，里面有url地址，消费者地址。之后在消费者注册表里把刚创建的invoker注册进去。注册进入subscribeUrl订阅地址。记录消费者消费哪个服务。</p>
<p><img src="Untitled%2043.png" alt="Untitled"></p>
<p>保存好了后返回到doRefer()</p>
<p><img src="Untitled%2044.png" alt="Untitled"></p>
<p>但后一直返回到createProxy。ref代理对象就创建好了，远程信息等都在里面存好了。</p>
<p>之后使用代理对象来执行远程调用方法。</p>
<p><img src="Untitled%2045.png" alt="Untitled"></p>
<h3 id="4-3-5、dubbo原理-服务调用"><a href="#4-3-5、dubbo原理-服务调用" class="headerlink" title="4.3.5、dubbo原理    -   服务调用"></a>4.3.5、dubbo原理    -   服务调用</h3><p>整体流程：</p>
<p><img src="Untitled%2046.png" alt="Untitled"></p>
<p>代理对象如何执行方法呢，在这里打个断点。</p>
<p><img src="Untitled%2047.png" alt="Untitled"></p>
<p>会调用invoke，并且会传入method和args并封装成一个叫RpcInvocation远程调用的对象。</p>
<p><img src="Untitled%2048.png" alt="Untitled"></p>
<p>之后再进一个Invoker，它里面封装了FailOverCluster，他是dubbo带集群容错功能的invoker</p>
<p><img src="Untitled%2049.png" alt="Untitled"></p>
<p>进去后查询有多少个可执行版本的方法，再获取负载均衡的机制，之后继续doInvoke</p>
<p><img src="Untitled%2050.png" alt="Untitled"></p>
<p>之后有个select能根据我们的负载均衡策略进行负载随机选择1个invoker</p>
<p><img src="Untitled%2051.png" alt="Untitled"></p>
<p>接下来调用invoker.invoke执行，到了真正要执行时还封装了一些filter，这个filter在最开始proxy代理对象要用invoker时会在外面封装filter来做（local、mock、cache）</p>
<p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docsv2.7/user/examples/local-mock/">https://dubbo.apache.org/zh/docsv2.7/user/examples/local-mock/</a></p>
<p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docsv2.7/user/examples/result-cache/">https://dubbo.apache.org/zh/docsv2.7/user/examples/result-cache/</a></p>
<p>缓存功能时，然后invoker选中了负载均衡功能后，又进入filter，filter就是各个统计信息（监控中心等）ProtocolFilter，ProtocolFilter里封装到最终时DubboInvoker.</p>
<p><img src="Untitled%2052.png" alt="Untitled"></p>
<p><img src="Untitled%2053.png" alt="Untitled"></p>
<p><img src="Untitled%2054.png" alt="Untitled"></p>
<p>在DubboInvoker中获取到在服务引用时建立的客户端，拿到引用的哪个远程服务，之后再request发起请求，返回结果。这里request就已经进入到底层了。之后拿客户端，拿通道。</p>
<p><img src="Untitled%2055.png" alt="Untitled"></p>
<p><img src="Untitled%2056.png" alt="Untitled"></p>
<p><img src="Untitled%2057.png" alt="Untitled"></p>
<p>然后给通道发送出去。</p>
<p><img src="Untitled%2058.png" alt="Untitled"></p>
<p>之后返回拿到返回结果对象，里面封装了结果数据</p>
<p><img src="Untitled%2059.png" alt="Untitled"></p>
<p>返回返回， 之后打印到控制台。</p>
<p><img src="Untitled%2060.png" alt="Untitled"></p>
<h1 id="5-结束语"><a href="#5-结束语" class="headerlink" title="5.结束语"></a>5.结束语</h1><p>祝大家学业有成</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Amzpiper</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://github.com/amzpiper/2021/08/13/Dubbo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">https://github.com/amzpiper/2021/08/13/Dubbo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://github.com/amzpiper" target="_blank">Amzpiper</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Dubbo/">Dubbo</a></div><div class="post_share"><div class="social-share" data-image="/2021/08/13/Dubbo%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/logo.jpeg" data-sites="twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/08/13/learn-elasticstack/"><img class="prev-cover" src="/2021/08/13/learn-elasticstack/Untitled.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Elasticstack学习笔记</div></div></a></div><div class="next-post pull-right"><a href="/2021/08/13/Spring%E7%AC%94%E8%AE%B0/"><img class="next-cover" src="https://spring.io/images/spring-logo-9146a4d3298760c2e7e49595184e1975.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring笔记</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="toc-text">一、基本知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA"><span class="toc-text">1 分布式基础理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-text">1.1什么是分布式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%8F%91%E5%B1%95%E6%BC%94%E5%8F%98%EF%BC%9A"><span class="toc-text">1.2 发展演变：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-RPC"><span class="toc-text">1.3 RPC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-dubbo%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">2 dubbo核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%AE%80%E4%BB%8B"><span class="toc-text">2.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-dubbo%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84"><span class="toc-text">2.2 dubbo设计架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-dubbo%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">3 dubbo环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%90%AD%E5%BB%BAZookeeper%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-text">3.1 搭建Zookeeper注册中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%90%AD%E5%BB%BA%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83"><span class="toc-text">3.2. 搭建监控中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-dubbo-helloworld"><span class="toc-text">4 dubbo-helloworld</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E7%9B%91%E6%8E%A7%E4%B8%AD%E5%BF%83"><span class="toc-text">5、监控中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81SpringBoot-%E6%95%B4%E5%90%88-Dubbo"><span class="toc-text">6、SpringBoot 整合 Dubbo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81dubbo%E9%85%8D%E7%BD%AE"><span class="toc-text">二、dubbo配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E9%85%8D%E7%BD%AE%E5%8E%9F%E5%88%99"><span class="toc-text">1、配置原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E9%87%8D%E8%AF%95%E6%AC%A1%E6%95%B0"><span class="toc-text">2、重试次数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-text">3、超时时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-text">4、版本号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%9C%AC%E5%9C%B0%E5%AD%98%E6%A0%B9"><span class="toc-text">5、本地存根</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81SpringBoot%E6%96%B9%E5%BC%8F%E9%85%8D%E7%BD%AE"><span class="toc-text">6、SpringBoot方式配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1%E3%80%81%E8%B6%85%E6%97%B6%E5%B1%9E%E6%80%A7"><span class="toc-text">6.1、超时属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2%E3%80%81SpringBoot%E4%B8%8EDubbo%E6%95%B4%E5%90%88%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-text">6.2、SpringBoot与Dubbo整合的三种方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-text">三、高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%E3%80%81zookeeper%E5%AE%95%E6%9C%BA%E4%B8%8Edubbo%E7%9B%B4%E8%BF%9E"><span class="toc-text">3.1、zookeeper宕机与dubbo直连</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2%E3%80%81%E9%9B%86%E7%BE%A4%E4%B8%8Bdubbo%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%BA%E5%88%B6"><span class="toc-text">3.2、集群下dubbo负载均衡机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1%E3%80%81Random-LoadBalance"><span class="toc-text">3.2.1、Random LoadBalance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2%E3%80%81RoundRobin-LoadBalance"><span class="toc-text">3.2.2、RoundRobin LoadBalance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3%E3%80%81LeastActive-LoadBalance"><span class="toc-text">3.2.3、LeastActive LoadBalance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4%E3%80%81ConsistentHash-LoadBalance"><span class="toc-text">3.2.4、ConsistentHash LoadBalance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-5%E3%80%81%E9%85%8D%E7%BD%AE"><span class="toc-text">3.2.5、配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3%E3%80%81%E6%95%B4%E5%90%88hystrix%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86"><span class="toc-text">3.3、整合hystrix，服务熔断与降级处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-text">3.3.1、服务降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2%E3%80%81%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99"><span class="toc-text">3.3.2、集群容错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3%E3%80%81%E5%AE%9E%E9%99%85%E5%BC%80%E5%8F%91%E6%95%B4%E5%90%88hystrix%E6%8F%90%E4%BE%9B%E5%AE%B9%E9%94%99%EF%BC%88SpringCloud%E9%BB%98%E8%AE%A4%E6%95%B4%E5%90%88%E7%9A%84%E6%A1%86%E6%9E%B6%EF%BC%89"><span class="toc-text">3.3.3、实际开发整合hystrix提供容错（SpringCloud默认整合的框架）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Dubbo%E5%8E%9F%E7%90%86"><span class="toc-text">四、Dubbo原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1%E3%80%81RPC%E5%8E%9F%E7%90%86"><span class="toc-text">4.1、RPC原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2%E3%80%81netty%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86"><span class="toc-text">4.2、netty通信原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3%E3%80%81dubbo%E5%8E%9F%E7%90%86"><span class="toc-text">4.3、dubbo原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1%E3%80%81dubbo%E5%8E%9F%E7%90%86-%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1"><span class="toc-text">4.3.1、dubbo原理    -   框架设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2%E3%80%81dubbo%E5%8E%9F%E7%90%86-%E5%90%AF%E5%8A%A8%E8%A7%A3%E6%9E%90%E3%80%81%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-text">4.3.2、dubbo原理    -   启动解析、加载配置信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3%E3%80%81dubbo%E5%8E%9F%E7%90%86-%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2"><span class="toc-text">4.3.3、dubbo原理    -   服务暴露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-4%E3%80%81dubbo%E5%8E%9F%E7%90%86-%E6%9C%8D%E5%8A%A1%E5%BC%95%E7%94%A8"><span class="toc-text">4.3.4、dubbo原理    -   服务引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-5%E3%80%81dubbo%E5%8E%9F%E7%90%86-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-text">4.3.5、dubbo原理    -   服务调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E7%BB%93%E6%9D%9F%E8%AF%AD"><span class="toc-text">5.结束语</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2015 - 2021 By Amzpiper</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div><script src="/my/jquery.min.js"></script><script src="/my/fishes.js"></script><script src="/my/lazyload.iife.min.js" async=""></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>